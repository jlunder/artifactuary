#include "scroll.h"


#define SCROLL_CHAR_WIDTH 8
#define SCROLL_CHAR_HEIGHT 8
#define SCROLL_CHARSET_START 32
#define SCROLL_CHARSET_END 128


typedef struct scroll_glyph {
    uint8_t scanlines[SCROLL_CHAR_HEIGHT];
} scroll_glyph_t;

scroll_glyph_t scroll_font[SCROLL_CHARSET_END - SCROLL_CHARSET_START];


scroll_glyph_t const* scroll_get_glyph(char c);
void scroll_draw(scroll_state_t* state, array_t* target_array, char const* text, int32_t text_offset, rgba_t text_color);


void scroll_init(scroll_state_t* state, int32_t width, int32_t height)
{
    state->array_width = width << 8;
    state->current_message = NULL;
    state->current_message_width = 0;
    state->next_message = NULL;
    state->next_message_width = 0;
    state->queued_message = NULL;
    state->scroll_distance = 0;
    state->scroll_speed = ((1 << 8) * 3 + 15) / 30; // 3 / 30 pixels per frame = 3 pixels per second
    
    assert(height >= SCROLL_CHAR_HEIGHT);
    
    state->vertical_pos = (height - SCROLL_CHAR_HEIGHT) / 2;
    
    state->current_message = strdup("H\x01ello Playa!");
    state->current_message_width = (strlen(state->current_message) * SCROLL_CHAR_WIDTH) << 8;
}


void scroll_process(scroll_state_t* state, float time, array_t* target_array)
{
    bool stable;
    
    if(state->current_message != NULL) {
        state->scroll_distance += state->scroll_speed;
    }
    
    do {
        stable = true;
        if((state->current_message != NULL) && (state->scroll_distance >= state->current_message_width + state->array_width)) {
            state->scroll_distance -= state->current_message_width;
            if(state->current_message != NULL) {
                free(state->current_message);
            }
            state->current_message = NULL;
            stable = false;
        }
        
        if((state->current_message == NULL) && (state->next_message != NULL)) {
            state->current_message = state->next_message;
            state->current_message_width = state->next_message_width;
            state->next_message = NULL;
            state->next_message_width = 0;
            stable = false;
        }
        
        if((state->next_message == NULL) && (state->queued_message != NULL)) {
            state->next_message = state->queued_message;
            state->next_message_width = (strlen(state->next_message) * 8) << 8;
            state->queued_message = NULL;
            stable = false;
        }
    } while(!stable);
    
    if(state->current_message == NULL) {
        state->scroll_distance = 0;
    }
    
    if(state->current_message != NULL) {
        rgba_t color = {{255, 255, 255, 255}};
        scroll_draw(state, target_array, state->current_message, state->scroll_distance, color);
        if(state->next_message != NULL) {
            scroll_draw(state, target_array, state->next_message, state->scroll_distance - state->current_message_width, color);
        }
    }
}


scroll_glyph_t const* scroll_get_glyph(char c)
{
    if((c < SCROLL_CHARSET_START) || (c >= SCROLL_CHARSET_END)) {
        return &scroll_font[rand() % (SCROLL_CHARSET_END - SCROLL_CHARSET_START)];
    }
    else {
        return &scroll_font[c - SCROLL_CHARSET_START];
    }
}


void scroll_draw(scroll_state_t* state, array_t* target_array, char const* text, int32_t text_offset, rgba_t text_color)
{
    int32_t pixel_pos = (state->array_width - text_offset) >> 8;
    
    //printf("drawing message \"%s\" at [%d] %d,%d\n", text, text_offset, pixel_pos, state->vertical_pos);
    
    while(pixel_pos < 0)
    {
        if(*text == 0) {
            return;
        }
        
        if(pixel_pos + SCROLL_CHAR_WIDTH > 0) {
            scroll_glyph_t const* glyph = scroll_get_glyph(*text);
            
            // a char clipped on the left
            for(int j = 0; j < SCROLL_CHAR_HEIGHT; ++j) {
                uint32_t scanline = glyph->scanlines[j];
                scanline = scanline >> -pixel_pos;
                for(int i = -pixel_pos; (scanline != 0) && (i < SCROLL_CHAR_WIDTH); ++i) {
                    if(scanline & 1) {
                        target_array->data[(state->vertical_pos + j) * target_array->width + pixel_pos + i] = text_color;
                    }
                    scanline = scanline >> 1;
                }
            }
        }
        
        pixel_pos += SCROLL_CHAR_WIDTH;
        ++text;
    }
    
    while(pixel_pos + SCROLL_CHAR_WIDTH < target_array->width) {
        scroll_glyph_t const* glyph;
        
        if(*text == 0) {
            return;
        }
        
        glyph = scroll_get_glyph(*text);
        // an unclipped char
        for(int j = 0; j < SCROLL_CHAR_HEIGHT; ++j) {
            uint32_t scanline = glyph->scanlines[j];
            for(int i = 0; (scanline != 0) && (i < SCROLL_CHAR_WIDTH); ++i) {
                if(scanline & 1) {
                     target_array->data[(state->vertical_pos + j) * target_array->width + pixel_pos + i] = text_color;
                }
                scanline = scanline >> 1;
            }
        }
        
        pixel_pos += SCROLL_CHAR_WIDTH;
        ++text;
    }
    
    if(*text == 0) {
        return;
    }
    if((pixel_pos < target_array->width) && (*text != 0)) {
        scroll_glyph_t const* glyph = scroll_get_glyph(*text);
        // a clipped char on the right!
        for(int j = 0; j < SCROLL_CHAR_HEIGHT; ++j) {
            uint32_t scanline = glyph->scanlines[j];
            for(int i = 0; (scanline != 0) && (i < (target_array->width - pixel_pos)); ++i) {
                if(scanline & 1) {
                    target_array->data[(state->vertical_pos + j) * target_array->width + pixel_pos + i] = text_color;
                }
                scanline = scanline >> 1;
            }
        }
    }
}


scroll_glyph_t scroll_font[SCROLL_CHARSET_END - SCROLL_CHARSET_START] = { 
    {.scanlines = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}},
    {.scanlines = {0x18, 0x18, 0x18, 0x18, 0x00, 0x00, 0x18, 0x00}},
    {.scanlines = {0x66, 0x66, 0x66, 0x00, 0x00, 0x00, 0x00, 0x00}},
    {.scanlines = {0x66, 0x66, 0xFF, 0x66, 0xFF, 0x66, 0x66, 0x00}},
    {.scanlines = {0x18, 0x7C, 0x06, 0x3C, 0x60, 0x3E, 0x18, 0x00}},
    {.scanlines = {0x46, 0x66, 0x30, 0x18, 0x0C, 0x66, 0x62, 0x00}},
    {.scanlines = {0x3C, 0x66, 0x3C, 0x1C, 0xE6, 0x66, 0xFC, 0x00}},
    {.scanlines = {0x60, 0x30, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00}},
    {.scanlines = {0x30, 0x18, 0x0C, 0x0C, 0x0C, 0x18, 0x30, 0x00}},
    {.scanlines = {0x0C, 0x18, 0x30, 0x30, 0x30, 0x18, 0x0C, 0x00}},
    {.scanlines = {0x00, 0x66, 0x3C, 0xFF, 0x3C, 0x66, 0x00, 0x00}},
    {.scanlines = {0x00, 0x18, 0x18, 0x7E, 0x18, 0x18, 0x00, 0x00}},
    {.scanlines = {0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x0C}},
    {.scanlines = {0x00, 0x00, 0x00, 0x7E, 0x00, 0x00, 0x00, 0x00}},
    {.scanlines = {0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x00}},
    {.scanlines = {0x00, 0xC0, 0x60, 0x30, 0x18, 0x0C, 0x06, 0x00}},
    {.scanlines = {0x3C, 0x66, 0x76, 0x6E, 0x66, 0x66, 0x3C, 0x00}},
    {.scanlines = {0x18, 0x18, 0x1C, 0x18, 0x18, 0x18, 0x7E, 0x00}},
    {.scanlines = {0x3C, 0x66, 0x60, 0x30, 0x0C, 0x06, 0x7E, 0x00}},
    {.scanlines = {0x3C, 0x66, 0x60, 0x38, 0x60, 0x66, 0x3C, 0x00}},
    {.scanlines = {0x60, 0x70, 0x78, 0x66, 0xFE, 0x60, 0x60, 0x00}},
    {.scanlines = {0x7E, 0x06, 0x3E, 0x60, 0x60, 0x66, 0x3C, 0x00}},
    {.scanlines = {0x3C, 0x66, 0x06, 0x3E, 0x66, 0x66, 0x3C, 0x00}},
    {.scanlines = {0x7E, 0x66, 0x30, 0x18, 0x18, 0x18, 0x18, 0x00}},
    {.scanlines = {0x3C, 0x66, 0x66, 0x3C, 0x66, 0x66, 0x3C, 0x00}},
    {.scanlines = {0x3C, 0x66, 0x66, 0x7C, 0x60, 0x66, 0x3C, 0x00}},
    {.scanlines = {0x00, 0x00, 0x18, 0x00, 0x00, 0x18, 0x00, 0x00}},
    {.scanlines = {0x00, 0x00, 0x18, 0x00, 0x00, 0x18, 0x18, 0x0C}},
    {.scanlines = {0x70, 0x18, 0x0C, 0x06, 0x0C, 0x18, 0x70, 0x00}},
    {.scanlines = {0x00, 0x00, 0x7E, 0x00, 0x7E, 0x00, 0x00, 0x00}},
    {.scanlines = {0x0E, 0x18, 0x30, 0x60, 0x30, 0x18, 0x0E, 0x00}},
    {.scanlines = {0x3C, 0x66, 0x60, 0x30, 0x18, 0x00, 0x18, 0x00}},
    {.scanlines = {0x3C, 0x66, 0x76, 0x76, 0x06, 0x46, 0x3C, 0x00}},
    {.scanlines = {0x18, 0x3C, 0x66, 0x7E, 0x66, 0x66, 0x66, 0x00}},
    {.scanlines = {0x3E, 0x66, 0x66, 0x3E, 0x66, 0x66, 0x3E, 0x00}},
    {.scanlines = {0x3C, 0x66, 0x06, 0x06, 0x06, 0x66, 0x3C, 0x00}},
    {.scanlines = {0x1E, 0x36, 0x66, 0x66, 0x66, 0x36, 0x1E, 0x00}},
    {.scanlines = {0x7E, 0x06, 0x06, 0x1E, 0x06, 0x06, 0x7E, 0x00}},
    {.scanlines = {0x7E, 0x06, 0x06, 0x1E, 0x06, 0x06, 0x06, 0x00}},
    {.scanlines = {0x3C, 0x66, 0x06, 0x76, 0x66, 0x66, 0x3C, 0x00}},
    {.scanlines = {0x66, 0x66, 0x66, 0x7E, 0x66, 0x66, 0x66, 0x00}},
    {.scanlines = {0x3C, 0x18, 0x18, 0x18, 0x18, 0x18, 0x3C, 0x00}},
    {.scanlines = {0x78, 0x30, 0x30, 0x30, 0x30, 0x36, 0x1C, 0x00}},
    {.scanlines = {0x66, 0x36, 0x1E, 0x0E, 0x1E, 0x36, 0x66, 0x00}},
    {.scanlines = {0x06, 0x06, 0x06, 0x06, 0x06, 0x06, 0x7E, 0x00}},
    {.scanlines = {0xC6, 0xEE, 0xFE, 0xD6, 0xC6, 0xC6, 0xC6, 0x00}},
    {.scanlines = {0x66, 0x6E, 0x7E, 0x7E, 0x76, 0x66, 0x66, 0x00}},
    {.scanlines = {0x3C, 0x66, 0x66, 0x66, 0x66, 0x66, 0x3C, 0x00}},
    {.scanlines = {0x3E, 0x66, 0x66, 0x3E, 0x06, 0x06, 0x06, 0x00}},
    {.scanlines = {0x3C, 0x66, 0x66, 0x66, 0x66, 0x3C, 0x70, 0x00}},
    {.scanlines = {0x3E, 0x66, 0x66, 0x3E, 0x1E, 0x36, 0x66, 0x00}},
    {.scanlines = {0x3C, 0x66, 0x06, 0x3C, 0x60, 0x66, 0x3C, 0x00}},
    {.scanlines = {0x7E, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x00}},
    {.scanlines = {0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x3C, 0x00}},
    {.scanlines = {0x66, 0x66, 0x66, 0x66, 0x66, 0x3C, 0x18, 0x00}},
    {.scanlines = {0xC6, 0xC6, 0xC6, 0xD6, 0xFE, 0xEE, 0xC6, 0x00}},
    {.scanlines = {0x66, 0x66, 0x3C, 0x18, 0x3C, 0x66, 0x66, 0x00}},
    {.scanlines = {0x66, 0x66, 0x66, 0x3C, 0x18, 0x18, 0x18, 0x00}},
    {.scanlines = {0x7E, 0x60, 0x30, 0x18, 0x0C, 0x06, 0x7E, 0x00}},
    {.scanlines = {0x3C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x3C, 0x00}},
    {.scanlines = {0x00, 0x06, 0x0C, 0x18, 0x30, 0x60, 0xC0, 0x00}},
    {.scanlines = {0x3C, 0x30, 0x30, 0x30, 0x30, 0x30, 0x3C, 0x00}},
    {.scanlines = {0x00, 0x18, 0x3C, 0x7E, 0x18, 0x18, 0x18, 0x18}},
    {.scanlines = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF}},
    {.scanlines = {0x06, 0x0C, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00}},
    {.scanlines = {0x00, 0x00, 0x3C, 0x60, 0x7C, 0x66, 0x7C, 0x00}},
    {.scanlines = {0x00, 0x06, 0x06, 0x3E, 0x66, 0x66, 0x3E, 0x00}},
    {.scanlines = {0x00, 0x00, 0x3C, 0x06, 0x06, 0x06, 0x3C, 0x00}},
    {.scanlines = {0x00, 0x60, 0x60, 0x7C, 0x66, 0x66, 0x7C, 0x00}},
    {.scanlines = {0x00, 0x00, 0x3C, 0x66, 0x7E, 0x06, 0x3C, 0x00}},
    {.scanlines = {0x00, 0x70, 0x18, 0x7C, 0x18, 0x18, 0x18, 0x00}},
    {.scanlines = {0x00, 0x00, 0x7C, 0x66, 0x66, 0x7C, 0x60, 0x3E}},
    {.scanlines = {0x00, 0x06, 0x06, 0x3E, 0x66, 0x66, 0x66, 0x00}},
    {.scanlines = {0x00, 0x18, 0x00, 0x1C, 0x18, 0x18, 0x3C, 0x00}},
    {.scanlines = {0x00, 0x60, 0x00, 0x60, 0x60, 0x60, 0x60, 0x3C}},
    {.scanlines = {0x00, 0x06, 0x06, 0x36, 0x1E, 0x36, 0x66, 0x00}},
    {.scanlines = {0x00, 0x1C, 0x18, 0x18, 0x18, 0x18, 0x3C, 0x00}},
    {.scanlines = {0x00, 0x00, 0x66, 0xFE, 0xFE, 0xD6, 0xC6, 0x00}},
    {.scanlines = {0x00, 0x00, 0x3E, 0x66, 0x66, 0x66, 0x66, 0x00}},
    {.scanlines = {0x00, 0x00, 0x3C, 0x66, 0x66, 0x66, 0x3C, 0x00}},
    {.scanlines = {0x00, 0x00, 0x3E, 0x66, 0x66, 0x3E, 0x06, 0x06}},
    {.scanlines = {0x00, 0x00, 0x7C, 0x66, 0x66, 0x7C, 0x60, 0x60}},
    {.scanlines = {0x00, 0x00, 0x3E, 0x66, 0x06, 0x06, 0x06, 0x00}},
    {.scanlines = {0x00, 0x00, 0x7C, 0x06, 0x3C, 0x60, 0x3E, 0x00}},
    {.scanlines = {0x00, 0x18, 0x7E, 0x18, 0x18, 0x18, 0x70, 0x00}},
    {.scanlines = {0x00, 0x00, 0x66, 0x66, 0x66, 0x66, 0x7C, 0x00}},
    {.scanlines = {0x00, 0x00, 0x66, 0x66, 0x66, 0x3C, 0x18, 0x00}},
    {.scanlines = {0x00, 0x00, 0xC6, 0xD6, 0xFE, 0x7C, 0x6C, 0x00}},
    {.scanlines = {0x00, 0x00, 0x66, 0x3C, 0x18, 0x3C, 0x66, 0x00}},
    {.scanlines = {0x00, 0x00, 0x66, 0x66, 0x66, 0x7C, 0x30, 0x1E}},
    {.scanlines = {0x00, 0x00, 0x7E, 0x30, 0x18, 0x0C, 0x7E, 0x00}},
    {.scanlines = {0x38, 0x0C, 0x0C, 0x06, 0x0C, 0x0C, 0x38, 0x00}},
    {.scanlines = {0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18}},
    {.scanlines = {0x1C, 0x30, 0x30, 0x60, 0x30, 0x30, 0x1C, 0x00}},
    {.scanlines = {0x00, 0x4C, 0x32, 0x00, 0x00, 0x00, 0x00, 0x00}},
    {.scanlines = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}},
};


